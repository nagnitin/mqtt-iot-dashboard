<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MQTT IoT Dashboard</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
    <!-- Paho MQTT (WebSockets) - load local vendored copy only (no CDN to avoid CORS/MIME issues) -->
    <script src="{{ url_for('static', filename='libs/mqttws31.min.js') }}"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Ensure MQTT library is loaded before app.js -->
    <script>
      if (typeof window.Paho === 'undefined') {
        console.error('MQTT library failed to load');
      } else {
        console.log('MQTT library loaded successfully');
      }
    </script>
  </head>
  <body>
    <header class="app-header">
      <div class="brand">
        <span class="logo">ðŸ”¥</span>
        <h1>Gas monitor</h1>
      </div>
      <div class="connection">
        <label>
          Host
          <input id="host" type="text" value="10.211.141.246" />
        </label>
        <label>
          WS Port
          <input id="port" type="number" value="9001" />
        </label>
        <button id="connectBtn" class="btn-primary"><span class="material-symbols-rounded">login</span>Connect</button>
        <button id="disconnectBtn" class="btn-ghost" disabled><span class="material-symbols-rounded">logout</span>Disconnect</button>
        <span id="connStatus" class="badge">Disconnected</span>
      </div>
    </header>

    <nav class="tabs">
      <button class="tab active" data-tab="dashboard"><span class="material-symbols-rounded">dashboard</span>Dashboard</button>
      <button class="tab" data-tab="servo"><span class="material-symbols-rounded">tune</span>Servo</button>
      <button class="tab" data-tab="mode"><span class="material-symbols-rounded">toggle_on</span>Mode</button>
      <button class="tab" data-tab="recipe"><span class="material-symbols-rounded">list_alt</span>Recipe</button>
      <button class="tab" data-tab="connection"><span class="material-symbols-rounded">settings_ethernet</span>Connection</button>
    </nav>

    <main>
      <!-- Dashboard Screen -->
      <section id="dashboard" class="tab-panel active">
        <div class="grid">
          <div class="card">
            <div class="card-header">
              <div class="card-title"><span class="material-symbols-rounded icon">tune</span><h3>Servo</h3></div>
              <div class="stat"><span id="servoAngleLabel">0</span><span class="unit">Â°</span></div>
            </div>
            <input id="servoSliderMirror" type="range" min="0" max="140" step="1" value="0" disabled />
            <div class="range-meta"><span>0Â°</span><span>70Â°</span><span>140Â°</span></div>
            <div class="timestamps">
              <div>â†‘ <span id="servoSentTs">--</span></div>
              <div>â†“ <span id="servoRecvTs">--</span></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title"><span class="material-symbols-rounded icon">toggle_on</span><h3>Mode</h3></div>
              <div class="row">
                <span id="modeStatus" class="chip chip-muted">Manual</span>
                <label class="switch">
                  <input id="modeToggleMirror" type="checkbox" disabled />
                  <span class="slider"></span>
                </label>
              </div>
            </div>
            <div class="timestamps">
              <div>â†‘ <span id="modeSentTs">--</span></div>
              <div>â†“ <span id="modeRecvTs">--</span></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title"><span class="material-symbols-rounded icon">notifications</span><h3>Alerts</h3></div>
            </div>
            <ul id="alertsList" class="list alerts"></ul>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title"><span class="material-symbols-rounded icon">list_alt</span><h3>Recipe</h3></div>
              <span id="recipeActive" class="chip chip-muted">-</span>
            </div>
            <div class="timestamps">
              <div>â†‘ <span id="recipeSentTs">--</span></div>
              <div>â†“ <span id="recipeRecvTs">--</span></div>
            </div>
          </div>
        </div>

        <div class="charts">
          <div class="card">
            <div class="card-header">
              <h3>Air quality</h3>
            </div>
            <canvas id="gasChart"></canvas>
          </div>

          <div class="card">
            <div class="card-header">
              <h3>Flame temperature</h3>
            </div>
            <canvas id="tempChart"></canvas>
          </div>
        </div>

        <!-- Custom Dashboard (IoT MQTT Panel style) -->
        <div class="card">
          <div class="card-header">
            <div class="card-title"><span class="material-symbols-rounded icon">dashboard_customize</span><h3>Custom Dashboard</h3></div>
            <div class="row">
              <button id="panelExportBtn" class="btn-ghost"><span class="material-symbols-rounded">ios_share</span>Export</button>
              <button id="panelImportBtn" class="btn-ghost"><span class="material-symbols-rounded">download</span>Import</button>
              <button id="panelAddToggle" class="btn-primary"><span class="material-symbols-rounded">add</span>Add Panel</button>
            </div>
          </div>
          <div id="panelForm" class="panel-form" style="display:none;">
            <div class="grid three">
              <label class="stack"><span class="label">Type</span>
                <select id="pfType">
                  <option value="switch">Switch</option>
                  <option value="slider">Slider</option>
                  <option value="textlog">Text Log</option>
                  <option value="chart">Chart</option>
                </select>
              </label>
              <label class="stack"><span class="label">Title</span><input id="pfTitle" placeholder="Panel title"/></label>
              <label class="stack"><span class="label">Color</span><input id="pfColor" type="color" value="#2dd4bf"/></label>
            </div>
            <div class="grid three">
              <label class="stack"><span class="label">Publish topic</span><input id="pfPub" placeholder="mobile/angle"/></label>
              <label class="stack"><span class="label">Subscribe topic</span><input id="pfSub" placeholder="arduino/to/pi"/></label>
              <label class="stack"><span class="label">QoS</span><input id="pfQos" type="number" value="0" min="0" max="2"/></label>
            </div>
            <div class="grid three">
              <label class="stack"><span class="label">Payload ON</span><input id="pfOn" placeholder="1"/></label>
              <label class="stack"><span class="label">Payload OFF</span><input id="pfOff" placeholder="0"/></label>
              <label class="stack"><span class="label">Retain</span><select id="pfRetain"><option value="false" selected>No</option><option value="true">Yes</option></select></label>
            </div>
            <div class="grid three">
              <label class="stack"><span class="label">Min</span><input id="pfMin" type="number" value="0"/></label>
              <label class="stack"><span class="label">Max</span><input id="pfMax" type="number" value="140"/></label>
              <label class="stack"><span class="label">Step</span><input id="pfStep" type="number" value="1"/></label>
            </div>
            <div class="row">
              <button id="panelAddBtn" class="btn-primary"><span class="material-symbols-rounded">add_circle</span>Create</button>
              <button id="panelCancelBtn" class="btn-ghost"><span class="material-symbols-rounded">close</span>Cancel</button>
            </div>
          </div>
          <div id="panelGrid" class="panel-grid"></div>
          <textarea id="panelImportText" class="mono" rows="6" style="display:none; width:100%; margin-top:10px;" placeholder="Paste exported JSON here then click Import again"></textarea>
        </div>
      </section>

      <!-- Servo Screen -->
      <section id="servo" class="tab-panel">
          <div class="card">
          <div class="card-header">
            <div class="card-title"><span class="material-symbols-rounded icon">tune</span><h3>Servo control</h3></div>
            <div class="stat"><span id="servoAngleOut">0</span><span class="unit">Â°</span></div>
          </div>
          <input id="servoSlider" type="range" min="0" max="140" step="1" value="0" disabled />
          <div class="range-meta"><span>0Â°</span><span>70Â°</span><span>140Â°</span></div>
          <div class="row">
            <button id="servoSendBtn" class="btn-primary" disabled><span class="material-symbols-rounded">send</span>Send</button>
            <label><input id="servoLive" type="checkbox" disabled /> Live publish while dragging</label>
          </div>
        </div>
      </section>

      <!-- Mode Screen -->
      <section id="mode" class="tab-panel">
        <div class="card">
          <div class="card-header">
            <h3>Mode</h3>
            <label class="switch">
              <input id="modeToggle" type="checkbox" disabled />
              <span class="slider"></span>
            </label>
          </div>
          <p>On = Recipe mode (will run the selected recipe). Off = Manual mode (servo uses slider value).</p>
        </div>
      </section>

      <!-- Recipe Screen -->
      <section id="recipe" class="tab-panel">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><span class="material-symbols-rounded icon">list_alt</span><h3>Recipe</h3></div>
            <span id="recipeActive" class="chip chip-muted">-</span>
          </div>
          <div class="list">
            <label><input type="radio" name="recipe" value="1" checked disabled /> recipe 1</label>
            <label><input type="radio" name="recipe" value="2" disabled /> recipe 2</label>
            <label><input type="radio" name="recipe" value="3" disabled /> recipe 3</label>
          </div>
          <div class="row">
            <button id="recipeSendBtn" class="btn-primary" disabled><span class="material-symbols-rounded">send</span>Send</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title"><span class="material-symbols-rounded icon">auto_awesome</span><h3>AI Recipe Generator</h3></div>
          </div>
          <div class="grid two">
            <label class="stack">
              <span class="label">Max angle (Â°)</span>
              <input id="aiMaxAngle" type="number" value="140" min="0" max="180" />
            </label>
          </div>
          <label class="stack">
            <span class="label">Prompt</span>
            <textarea id="aiPrompt" rows="4" placeholder="Describe the sequence you want (e.g., sweep slowly to 140Â°, pause, return to 90Â°, etc.)"></textarea>
          </label>
          <div class="row">
            <button id="aiGenerateBtn" class="btn-primary"><span class="material-symbols-rounded">sparkles</span>Generate</button>
            <button id="aiApplyBtn" class="btn-ghost" disabled><span class="material-symbols-rounded">play_arrow</span>Apply & Run</button>
          </div>
          <pre id="aiOutput" class="mono muted" style="white-space:pre-wrap; overflow:auto; max-height:180px; margin-top:10px;">Output will appear hereâ€¦</pre>
        </div>
      </section>

      <!-- Connection Screen -->
      <section id="connection" class="tab-panel">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><span class="material-symbols-rounded icon">router</span><h3>Edit Connection</h3></div>
          </div>
          <form id="connForm" autocomplete="off" onsubmit="return false;">
          <div class="grid two">
            <label class="stack">
              <span class="label">Connection name</span>
              <input id="connName" placeholder="My Pi MQTT" />
            </label>
            <label class="stack">
              <span class="label">Client ID</span>
              <input id="connClientId" placeholder="MobileClient" />
            </label>
          </div>

          <div class="grid three">
            <label class="stack">
              <span class="label">Broker address</span>
              <input id="connHost" placeholder="192.168.1.50" />
            </label>
            <label class="stack">
              <span class="label">Port (WebSocket)</span>
              <input id="connPort" type="number" value="9001" />
            </label>
            <label class="stack">
              <span class="label">Path</span>
              <input id="connPath" placeholder="/mqtt" value="/mqtt" />
            </label>
          </div>

          <div class="grid two" style="margin-top:8px;">
            <label class="stack">
              <span class="label">Network protocol</span>
              <select id="connProtocol">
                <option value="ws" selected>WebSocket (ws)</option>
                <option value="wss">WebSocket-SSL (wss)</option>
                <option value="tcp" disabled>TCP (not supported in browser)</option>
                <option value="tcpssl" disabled>TCP-SSL (not supported in browser)</option>
              </select>
            </label>
          </div>

          <div class="grid three">
            <label class="stack">
              <span class="label">Keep alive (s)</span>
              <input id="connKeepAlive" type="number" value="60" />
            </label>
            <label class="stack">
              <span class="label">Username (optional)</span>
              <input id="connUsername" />
            </label>
            <label class="stack">
              <span class="label">Password (optional)</span>
              <input id="connPassword" type="password" name="password" />
            </label>
          </div>

          <div class="row" style="margin: 8px 0 12px; gap: 18px;">
            <label><input id="connCleanSession" type="checkbox" checked /> Clean session</label>
            <label><input id="connUseTLS" type="checkbox" /> Use TLS (wss)</label>
            <label><input id="connAuto" type="checkbox" /> Auto connect</label>
          </div>

          <div class="row">
            <button id="connSaveBtn" type="button" class="btn-ghost"><span class="material-symbols-rounded">save</span>Save</button>
            <button id="connConnectBtn" type="button" class="btn-primary"><span class="material-symbols-rounded">login</span>Connect</button>
          </div>
          </form>
        </div>
      </section>
    </main>

    <footer class="footer">
      <span>Topics:</span>
      <code>mobile/angle</code>
      <code>mobile/mode</code>
      <code>mobile/recipe</code>
      <code>arduino/to/pi</code>
      <code>arduino/alert</code>
      <code>alert</code>
    </footer>

    <script src="{{ url_for('static', filename='app.js') }}"></script>
  </body>
  </html> 